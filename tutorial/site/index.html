
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Combine OpenCL and OpenGL to create a GPU-accelerated particle system with shared buffers.">
      
      
        <meta name="author" content="John Klucinec">
      
      
        <link rel="canonical" href="/">
      
      
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="zensical-0.0.20">
    
    
      
        <title>OpenCL/OpenGL Interop Particle System - OpenCL/OpenGL Particle System</title>
      
    
    
      
        
      
      <link rel="stylesheet" href="assets/stylesheets/modern/main.d4922b3c.min.css">
      
        
          
        
        <link rel="stylesheet" href="assets/stylesheets/modern/palette.dfe2e883.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,500,500i,700,700i%7CJetbrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Jetbrains Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,t)=>(e<<5)-e+t.charCodeAt(0)),0),__md_get=(e,t=localStorage,a=__md_scope)=>JSON.parse(t.getItem(a.pathname+"."+e)),__md_set=(e,t,a=localStorage,_=__md_scope)=>{try{a.setItem(_.pathname+"."+e,JSON.stringify(t))}catch(e){}},document.documentElement.setAttribute("data-platform",navigator.platform)</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#openclopengl-interop-particle-system" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="" title="OpenCL&#x2f;OpenGL Particle System" class="md-header__button md-logo" aria-label="OpenCL/OpenGL Particle System" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-book-open" viewBox="0 0 24 24"><path d="M12 7v14M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-menu" viewBox="0 0 24 24"><path d="M4 5h16M4 12h16M4 19h16"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenCL/OpenGL Particle System
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OpenCL/OpenGL Interop Particle System
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-moon" viewBox="0 0 24 24"><path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-search" viewBox="0 0 24 24"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog" aria-label="Search">
  <button type="button" class="md-search__button">
    Search
  </button>
</div>
      
    
    <div class="md-header__source">
      
    </div>
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="" title="OpenCL&#x2f;OpenGL Particle System" class="md-nav__button md-logo" aria-label="OpenCL/OpenGL Particle System" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-book-open" viewBox="0 0 24 24"><path d="M12 7v14M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"/></svg>

    </a>
    OpenCL/OpenGL Particle System
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    OpenCL/OpenGL Interop Particle System
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenCL/OpenGL Interop Particle System
  

    
  </span>
  
  

      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goal" class="md-nav__link">
    <span class="md-ellipsis">
      
        Goal
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Started
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#project-layout" class="md-nav__link">
    <span class="md-ellipsis">
      
        Project Layout
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Requirements
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-set-local-work-group-size" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Set Local Work-Group Size
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-set-optimal-steps-per-frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Set Optimal Steps Per Frame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-add-additional-bumper-object" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Add Additional Bumper Object
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-implement-dynamic-color-changes" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Implement Dynamic Color Changes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-test-performance" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Test Performance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-show-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Show Results
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-demonstrate-your-program-in-action" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Demonstrate your program in action
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-commentary-in-the-pdf-file" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Commentary in the PDF file
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tips
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grading" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grading
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


              
              <article class="md-content__inner md-typeset">
                
                  

<h1 id="openclopengl-interop-particle-system">OpenCL/OpenGL Interop Particle System</h1>
<h2 id="introduction">Introduction</h2>
<p>Particle systems are used in games, films, and visual effects to simulate natural phenomena such as clouds, dust, fireworks, fire, explosions, water flow, sand, swarms of insects, and even herds of animals. Once you understand how they work, you'll notice them everywhere.</p>
<p>A particle system operates by controlling an extensive collection of individual 3D particles to exhibit some behavior. For a deeper technical overview, see <a href="https://web.engr.oregonstate.edu/~mjb/cs491/Handouts/particlesystems.2pp.pdf">Mike Bailey's slide</a>.</p>
<div class="admonition quote">
<p class="admonition-title">Fun Fact</p>
<p>Particle systems were first seen in <a href="https://youtu.be/LNELRd7E3EQ?t=164">Star Trek II: The Wrath of Khan Genesis Demo</a>, animated over 40 years ago. While the technology has evolved significantly since then, this groundbreaking sequence introduced the concept to computer graphics.</p>
</div>
<hr />
<h2 id="goal">Goal</h2>
<p>In this project, you will combine OpenCL and OpenGL to create your own particle system.  The project template includes a complete solution for one million (1024 x 1024) particles, one sphere bumper, and no color changes. The files you need to change are <code>sample.cpp</code> and <code>particles.cl</code>. The degree of "cool-ness" is up to you, but here is a minimum checklist you must complete to get full credit. For more in-depth instructions, see the Requirements section.</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Choose an appropriate <code>LOCAL_SIZE</code> value</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Select an optimal <code>STEPS_PER_FRAME</code> value  </li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Add at least one additional bumper object (sphere)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Implement dynamic particle color changes</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Test performance with varying particle counts</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Create a graph to visualize your results</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Demonstrate your program in action</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">What interoperability or "interop" means here</p>
<p>OpenGL owns the VBOs (<em>for rendering</em>), OpenCL temporarily acquires those same buffers, writes new particle data, releases them back, and then OpenGL draws the updated data.</p>
</div>
<hr />
<h2 id="getting-started">Getting Started</h2>
<p>This project uses CMake as the build system to ensure it runs on Windows, macOS, and Linux. It's written in C++ 17 and uses OpenGL 4.1 and OpenCL 1.2, as these are the latest versions supported on macOS. OpenMP is used for kernel benchmarking. If you need to install any of these, detailed instructions for each operating system are provided below.</p>
<h4 id="project-layout">Project Layout</h4>
<div class="language-text highlight"><pre><span></span><code>├─ src/                 # Libraries, utils, and shaders
├─ .clang-format        # Style Guide
├─ .clangd              
├─ CMakeLists.txt
├─ main.cpp             # You will edit this file
└─ particles.cl         # You will edit this file   
</code></pre></div>
<p>To build the project, run these commands from your terminal:</p>
<div class="language-bash highlight"><pre><span></span><code>cmake<span class="w"> </span>-B<span class="w"> </span>build
cmake<span class="w"> </span>--build<span class="w"> </span>build
</code></pre></div>
<details class="info">
<summary>Windows</summary>
<p>TODO</p>
</details>
<details class="info">
<summary>MacOS</summary>
<p>TODO</p>
</details>
<details class="info">
<summary>Linux</summary>
<p>TODO</p>
</details>
<hr />
<h2 id="requirements">Requirements</h2>
<h4 id="1-set-local-work-group-size">1. Set Local Work-Group Size</h4>
<p>Set the local work-group size (<code>LOCAL_SIZE</code>) to some fixed value. You can determine an appropriate value by setting <code>PRINTINFO</code> to true, which shows the maximum work-group size your GPU supports. Since this particle system uses simple calculations, pick a reasonable power of 2 (like 128 or 256) within that maximum, set it once, and leave it.</p>
<h4 id="2-set-optimal-steps-per-frame">2. Set Optimal Steps Per Frame</h4>
<p>First, it's important to understand how the default program flow works</p>
<details>
<summary>Program Execution Flow</summary>
<p><figure markdown="span">
  <img alt="Image title" src="images\interop_light.png#only-light" />
  <img alt="Image title" src="images\interop_dark.png#only-dark" /></p>
<p><figcaption>
<a href="https://web.engr.oregonstate.edu/~mjb/cs575/Handouts/opencl.opengl.vbo.1pp.pdf#page=2" title="Modified from Mike Bailey">Source</a></p>
</figcaption>
</figure>
</details>
<p>Looking at the graph, once we set up the data on the OpenGL side, OpenCL acquires it. As explained in the OpenCL/GL Interoperability notes, synchronization is required because only one can hold the buffer at a time. OpenCL runs a kernel that reads an x, y, and z value, updates it according to projectile motion laws, writes it back to the buffer, and releases it. OpenGL then draws the buffer, and the cycle repeats.</p>
<p>While this system works, it means only one physics update happens per visual frame. If you're locked to your monitor's refresh rate (<em>let's assume 60Hz</em>), you'll draw 60 frames per second, which is your framerate.</p>
<p>But here's the catch: <strong>Just because you can only draw 60 frames per second doesn't mean you can only compute 60 times per second.</strong></p>
<p><code>STEPS_PER_FRAME)</code> determines how many compute kernels are launched before drawing a frame. We want to know "How fast can my GPU update particles?" not "How many frames can I draw?" When <code>STEPS_PER_FRAME</code> is set higher than 1, you're running multiple physics updates per visual frame.</p>
<p>Think of your GPU like a delivery truck. Every frame is a "trip", and every kernel compute is a "package".</p>
<ul>
<li><strong>Make 1 delivery per trip</strong> (<code>STEPS_PER_FRAME</code> = 1): You drive to one house, drop off a package, drive all the way back, then wait for the next scheduled trip. Inefficient!</li>
<li><strong>Make 10 deliveries per trip</strong> (<code>STEPS_PER_FRAME</code> = 10): You drive out once, hit 10 houses, then come back. You're doing 10 times more work in the same wall-clock time.</li>
</ul>
<p>Your GPU has limits, so setting the value too high will hurt your framerate. Your goal is to find the value that stresses your GPU the most while maintaining fluid motion. An easy way is to increase the value until your FPS drops to around your monitor's refresh rate.</p>
<div class="admonition note">
<p class="admonition-title">Test with your maximum particle count when finding this value.</p>
</div>
<h4 id="3-add-additional-bumper-object">3. Add Additional Bumper Object</h4>
<p>Your simulation must have at least <strong>two</strong> "bumpers" in it for the particles to bounce off of. Each bumper needs to be geometrically designed such that, given particles XYX, you can quickly tell if that particle is inside or outside the bumper. To get the bounce right, each bumper must know its outward-facing surface normal everywhere.</p>
<p>What's the easiest shape for a bumper? A sphere! In computer graphics, we love spheres as they are computationally "nice". It's fast and straightforward to tell if something is inside or outside of a sphere. It's just as straightforward to determine a normal vector for a point on the surface of a sphere, too.</p>
<p>It is OK to assume that the two bumpers are separate from each other; that is, a particle cannot collide with both at the same time.</p>
<p>Your OpenCL <code>.cl</code> program must also handle bounces from your (&gt;=2) bumpers. Be sure to draw these bumpers in your <code>.cpp</code> program in <code class="language-cpp highlight"><span class="n">InitLists</span><span class="p">()</span></code> so that you can see where they are.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Don't forget to update the <code>.cl</code> kernel code with the <strong>same</strong> values you set in your <code>.cpp</code> code.</p>
</div>
<h4 id="4-implement-dynamic-color-changes">4. Implement Dynamic Color Changes</h4>
<p>The sample OpenCL code does not retrieve the colors, modify them, or restore them. However, your <code>.cl</code> kernel needs to change the particles' colors dynamically. You could base this on position, velocity, time, bounce knowledge, etc. The way they change is up to you, but the color of each particle needs to change in some predictable way during the simulation.</p>
<div class="admonition note">
<p class="admonition-title">OpenGL defines the red, green, and blue components of a color each as a floating-point value between <code>0.0</code> and <code>1.0</code></p>
</div>
<h4 id="5-test-performance">5. Test Performance</h4>
<p>Vary the total number of particles from something small-ish (~1024) to something big-ish (~1024*1024) in some increments that will look good on the graph.</p>
<p>If you check the "show performance" box, you will see current, peak, and average measurements. Let the simulation run for a few seconds, and then write down your <strong>Average</strong> GigaParticles/Sec.</p>
<h4 id="6-show-results">6. Show Results</h4>
<p>Make a table and a graph of Performance versus Total Number of Particles.</p>
<details class="note">
<summary>That this will just be one graph with one curve.</summary>
<p>TODO: Add graph example + python code to make one?</p>
</details>
<div class="admonition example">
<p class="admonition-title">Bonus</p>
<p>If you have some free time, run all the tests again with different work group sizes and compare the results.</p>
</div>
<h4 id="7-demonstrate-your-program-in-action">7. Demonstrate your program in action</h4>
<p>Make a video of your program in action and be sure it's Unlisted. You can use any video-capture tool you want. If you have never done this before, I recommend Kaltura, for which OSU has a site license for you to use. You can access the Kaltura noteset here. If you use Kaltura, be sure your video is set to Unlisted. If it isn't, then we won't be able to see it, and we can't grade your project.</p>
<p>Sites like YouTube also work. Just make sure your video is either public or unlisted, not <strong>private</strong>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Copy and paste your video link into an incognito tab and see if it plays. If it does, you should be good to go.</p>
</div>
<h4 id="8-commentary-in-the-pdf-file">8. Commentary in the PDF file</h4>
<p>Your commentary PDF should include:</p>
<ol>
<li>A web link to the video showing your program in action -- be sure your video is Unlisted.</li>
<li>What machine did you run this on?</li>
<li>What predictable dynamic thing did you do with the particle colors (random changes are not good enough)?</li>
<li>Include at least one screenshot of your project in action</li>
<li>Show the table and graph.</li>
<li>What patterns are you seeing in the performance curve?</li>
<li>Why do you think the patterns look this way?</li>
<li>What does that mean for the proper use of GPU parallel computing?</li>
</ol>
<hr />
<h2 id="tips">Tips</h2>
<details class="abstract">
<summary>Explaining the Sample Code – TODO</summary>
<p>TODO: Add explaination</p>
</details>
<details class="abstract">
<summary>Explaining the Kernel – Advancing a Particle by DT TODO: UPDATE CODE</summary>
<p>In the sample code, Joe Parallel wanted to clean up the code by treating x, y, z positions and velocities as single variables instead of handling each component separately. To do this, he created custom types called <code>point</code>, <code>vector</code>, and <code>color</code> using typedef, all backed by OpenCL's <code>float4</code> type. (OpenCL doesn't have a <code>float3</code>, so <code>float4</code> is the next best option, the fourth component goes unused.) He also stored sphere definitions as a <code>float4</code>, packing the center coordinates and radius as x, y, z, r.</p>
<div class="language-cpp highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="n">float4</span><span class="w"> </span><span class="n">point</span><span class="p">;</span><span class="w">   </span><span class="c1">// x, y, z, 1.</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">float4</span><span class="w"> </span><span class="n">vector</span><span class="p">;</span><span class="w">  </span><span class="c1">// vx, vy, vz, 0.</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">float4</span><span class="w"> </span><span class="n">color</span><span class="p">;</span><span class="w">   </span><span class="c1">// r, g, b, a</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">float4</span><span class="w"> </span><span class="n">sphere</span><span class="p">;</span><span class="w">  </span><span class="c1">// x, y, z, r</span>

<span class="n">constant</span><span class="w"> </span><span class="n">sphere</span><span class="w"> </span><span class="n">Sphere1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sphere</span><span class="p">)(</span><span class="w"> </span><span class="mf">-100.</span><span class="p">,</span><span class="w"> </span><span class="mf">-800.</span><span class="p">,</span><span class="w"> </span><span class="mf">0.</span><span class="p">,</span><span class="w"> </span><span class="mf">600.</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>Joe Parallel also stored the (x,y,z) acceleration of gravity in a <code>float4</code>:</p>
<div class="language-cpp highlight"><pre><span></span><code><span class="n">constant</span><span class="w"> </span><span class="n">float4</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">float4</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-9.8</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
</code></pre></div>
<p>Now, given a particle's position <code>point p</code> and a particle's velocity <code>vector v</code>, here is how you advance it one time step:</p>
<div class="language-cpp highlight"><pre><span></span><code><span class="n">kernel</span>
<span class="kt">void</span>
<span class="n">Particle</span><span class="p">(</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">*</span><span class="n">dPobj</span><span class="p">,</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">*</span><span class="n">dVel</span><span class="p">,</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">*</span><span class="n">dCobj</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_global_id</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// particle number</span>

<span class="w">    </span><span class="n">point</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dPobj</span><span class="p">[</span><span class="n">gid</span><span class="p">];</span>
<span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dVel</span><span class="p">[</span><span class="n">gid</span><span class="p">];</span>
<span class="w">    </span><span class="n">color</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dCobj</span><span class="p">[</span><span class="n">gid</span><span class="p">];</span>

<span class="w">    </span><span class="n">point</span><span class="w"> </span><span class="n">pp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="o">*</span><span class="n">DT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="o">*</span><span class="p">(</span><span class="n">point</span><span class="p">)(</span><span class="w"> </span><span class="mf">.5</span><span class="o">*</span><span class="n">DT</span><span class="o">*</span><span class="n">DT</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// p&#39;</span>
<span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="n">vp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="o">*</span><span class="n">DT</span><span class="p">;</span><span class="w"> </span><span class="c1">// v&#39;</span>

<span class="w">    </span><span class="n">pp</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">vp</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
</code></pre></div>
<p>Bouncing is handled by changing the velocity vector according to the outward-facing surface normal of the bumper at the point right before an impact:</p>
<div class="language-cpp highlight"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">IsInsideSphere</span><span class="p">(</span><span class="w"> </span><span class="n">pp</span><span class="p">,</span><span class="w"> </span><span class="n">Sphere1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">vp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BounceSphere</span><span class="p">(</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">Sphere1</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="n">pp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vp</span><span class="o">*</span><span class="n">DT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="o">*</span><span class="p">(</span><span class="n">point</span><span class="p">)(</span><span class="w"> </span><span class="mf">.5</span><span class="o">*</span><span class="n">DT</span><span class="o">*</span><span class="n">DT</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>And then do this again for the second bumper object. Assigning the new positions and velocities back into the global buffers happens like this:</p>
<div class="language-cpp highlight"><pre><span></span><code><span class="w">    </span><span class="n">dPobj</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pp</span><span class="p">;</span>
<span class="w">    </span><span class="n">dVel</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vp</span><span class="p">;</span>
<span class="w">    </span><span class="n">dCobj</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">????</span><span class="p">;</span><span class="w"> </span><span class="c1">// some change in color based on something </span>
<span class="w">                    </span><span class="c1">// happening in the simulation</span>
<span class="p">}</span>
</code></pre></div>
<p><em>Some utility functions you might find helpful:</em></p>
<div class="language-cpp highlight"><pre><span></span><code><span class="kt">bool</span>
<span class="nf">IsInsideSphere</span><span class="p">(</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">sphere</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fast_length</span><span class="p">(</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">xyz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">xyz</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span class="n">vector</span>
<span class="nf">Bounce</span><span class="p">(</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">n</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fast_normalize</span><span class="p">(</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">vector</span><span class="p">)(</span><span class="w"> </span><span class="mf">2.</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">xyz</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// angle of reflection equals</span>
<span class="w">                                                            </span><span class="c1">// angle of incidence</span>
<span class="w">    </span><span class="n">out</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span class="n">vector</span>
<span class="nf">BounceSphere</span><span class="p">(</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">sphere</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="n">n</span><span class="p">.</span><span class="n">xyz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fast_normalize</span><span class="p">(</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">xyz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">xyz</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">n</span><span class="p">.</span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Bounce</span><span class="p">(</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</details>
<details class="abstract">
<summary>Getting an Error Message that says something about "UTF-8"?</summary>
<p>TODO: Find the actual source for this:
This is the problem where Windows text editors put 2 marks at the end of a text line instead of the expected one mark.
Refer to Slide #43 of the Project Notes noteset. </p>
</details>
<details class="abstract">
<summary>Determining Platform and Device Information</summary>
<p>TODO: Add stuff about VSYNC</p>
<p>The sample code includes code from the printinfo program. This will show what OpenCL capabilities are on your system. The code will also attempt to pick the best OpenCL environment. Feel free to change this if you think it has picked the wrong one. </p>
</details>
<hr />
<h2 id="grading">Grading</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Requirement</th>
<th style="text-align: left;">Points</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Convincing particle motion</td>
<td style="text-align: left;">20</td>
</tr>
<tr>
<td style="text-align: left;">Bouncing from at least two bumpers</td>
<td style="text-align: left;">20</td>
</tr>
<tr>
<td style="text-align: left;">Predictable dynamic color changes (random changes are not good enough)</td>
<td style="text-align: left;">30</td>
</tr>
<tr>
<td style="text-align: left;">Performance table and graph</td>
<td style="text-align: left;">20</td>
</tr>
<tr>
<td style="text-align: left;">Commentary in the PDF file</td>
<td style="text-align: left;">30</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Potential Total</strong></td>
<td style="text-align: left;"><strong>120</strong></td>
</tr>
</tbody>
</table>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>The motion, bouncing, and colors of the particles need to be demonstrated via a video link. If it is a Kaltura video, be sure it has been set to <strong>Unlisted</strong>.</p>
</div>









  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-circle-arrow-up" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4M12 16V8"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2026, <a href="https://www.linkedin.com/in/john-klucinec/">John Klucinec</a>

    </div>
  
  
    Made with
    <a href="https://zensical.org/" target="_blank" rel="noopener">
      Zensical
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/john-klucinec/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M64 32C28.7 32 0 60.7 0 96v320c0 35.3 28.7 64 64 64h320c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64zm5 170.2h66.5V416H69zm71.7-67.7a38.5 38.5 0 1 1-77 0 38.5 38.5 0 1 1 77 0M317.9 416V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://johnklucinec.vercel.app/" target="_blank" rel="noopener" title="johnklucinec.vercel.app" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      
      <script id="__config" type="application/json">{"annotate":null,"base":".","features":["announce.dismiss","content.code.annotate","content.code.copy","content.code.select","content.footnote.tooltips","content.tabs.link","content.tooltips","navigation.footer","navigation.indexes","navigation.instant","navigation.instant.prefetch","navigation.path","navigation.sections","navigation.top","navigation.tracking","search.highlight","toc.integrate"],"search":"assets/javascripts/workers/search.e2d2d235.min.js","tags":null,"translations":{"clipboard.copied":"Copied to clipboard","clipboard.copy":"Copy to clipboard","search.result.more.one":"1 more on this page","search.result.more.other":"# more on this page","search.result.none":"No matching documents","search.result.one":"1 matching document","search.result.other":"# matching documents","search.result.placeholder":"Type to start searching","search.result.term.missing":"Missing","select.version":"Select version"},"version":null}</script>
    
    
      <script src="assets/javascripts/bundle.8ffeb9c9.min.js"></script>
      
    
  </body>
</html>